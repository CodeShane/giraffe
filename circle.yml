machine:
  java:
    version: openjdk8
  post:
    - wget -O /tmp/github-release.tar.bz2 https://github.com/aktau/github-release/releases/download/v0.7.1/linux-amd64-github-release.tar.bz2
    - sudo tar -C /usr/local/bin --strip-components 3 -xf /tmp/github-release.tar.bz2

dependencies:
  override:
    - ./gradlew resolveDependencies --console=plain --parallel

test:
  override:
    - ? >
        case $CIRCLE_NODE_INDEX in
        0) ./gradlew build --console=plain --parallel ;;
        1) ./gradlew linuxIntegrationTest --console=plain --parallel ;;
        esac
      :
        parallel: true
  post:
    - ./gradlew copyCircleArtifacts --console=plain --parallel

deployment:
  release:
    tag: /[0-9]+(\.[0-9]+)*/
    owner: palantir
    commands:
      - ./gradlew publish --console=plain
      - >
        github-release upload \
          --user ${CIRCLE_PROJECT_USERNAME} \
          --repo ${CIRCLE_PROJECT_REPONAME} \
          --tag ${CIRCLE_TAG} \
          --name "giraffe-release-${CIRCLE_TAG}.zip" \
          --file build/distributions/*.zip
